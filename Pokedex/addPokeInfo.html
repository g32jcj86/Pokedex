<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Login">
    <meta name="author" content="Xuan-Hong,Liu">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增寶可夢資訊</title>
    <link rel="Shortcut Icon" href="img/background/favicon.ico" type="image/gif" sizes="16x16">
    <link rel="stylesheet" type="text/css" href="css/loading.css" />
    <link rel="stylesheet" href="css/pagesetting.css">
    <script src="js/jquery.js"></script>
    <script src="js/pokemoninfo.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/subroutine.js"></script>
    <link href="css/register.css" rel="stylesheet" />
    <script>
        var loginTemp;
        if (document.cookie.length > 10) {
            var start = document.cookie.indexOf("login=") + 6;
            var end = document.cookie.indexOf(";", start);
            loginTemp = document.cookie.substring(start, end);
        }
        if (!loginTemp)
            logout();
    </script>
</head>
<body>
    <div class="container" id="boundary">
        <div class="row header">
            <a href="index.html">
                <div id="logo"></div>
            </a>
            <div class="title" onclick="jump2()" id="title2">寶可夢資料</div>
            <div class="logIn">
                <a href="#" onclick="goLogin()">登入</a> /
                <a href="#" onclick="goRegister()">註冊</a>
            </div>
        </div><br>

        <div class="signup-form">
            <form action="" method="post" enctype="multipart/form-data">
                <h2 id="titleTxtA">新增</h2>
                <p class="hint-text" id="titleTxtB">建立寶可夢資料</p>
                <div class="form-group">
                    <span>編號 :<a style="font-size:0.5rem;color:red;visibility:hidden;" id="numA">*必填欄位</a></span>
                    <input type="text" class="form-control" name="num" id="num" placeholder="輸入編號 ; 例如:810" maxlength="4">
                </div>
                <div class="form-group">
                    <span>名稱 :<a style="font-size:0.5rem;color:red;visibility:hidden;" id="nameA">*必填欄位</a></span>
                    <input type="text" class="form-control" name="cName" id="cName" placeholder="輸入名稱 ; 例如:敲音猴" maxlength="5">
                </div>
                <div class="form-group">
                    <div>
                        <span>屬性 1 :</span>
                        <select style="width:110px" id="typeA">
                            <option value="" selected="selected">無</option>
                            <option value="一般">一般</option>
                            <option value="格鬥">格鬥</option>
                            <option value="飛行">飛行</option>
                            <option value="毒">毒</option>
                            <option value="地面">地面</option>
                            <option value="岩石">岩石</option>
                            <option value="蟲">蟲</option>
                            <option value="幽靈">幽靈</option>
                            <option value="鋼">鋼</option>
                            <option value="火">火</option>
                            <option value="水">水</option>
                            <option value="草">草</option>
                            <option value="電">電</option>
                            <option value="超能力">超能力</option>
                            <option value="冰">冰</option>
                            <option value="龍">龍</option>
                            <option value="惡">惡</option>
                            <option value="妖精">妖精</option>
                        </select>
                        <span>屬性 2 :</span>
                        <select style="width:110px" id="typeB">
                            <option value="" selected="selected">無</option>
                            <option value="一般">一般</option>
                            <option value="格鬥">格鬥</option>
                            <option value="飛行">飛行</option>
                            <option value="毒">毒</option>
                            <option value="地面">地面</option>
                            <option value="岩石">岩石</option>
                            <option value="蟲">蟲</option>
                            <option value="幽靈">幽靈</option>
                            <option value="鋼">鋼</option>
                            <option value="火">火</option>
                            <option value="水">水</option>
                            <option value="草">草</option>
                            <option value="電">電</option>
                            <option value="超能力">超能力</option>
                            <option value="冰">冰</option>
                            <option value="龍">龍</option>
                            <option value="惡">惡</option>
                            <option value="妖精">妖精</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <span>特性 1 :</span>
                    <input type="text" class="form-control" name="abilityA" id="abilityA" placeholder="輸入特性 ; 例如:茂盛" maxlength="5">
                </div>
                <div class="form-group">
                    <span>特性 2 :</span>
                    <input type="text" class="form-control" name="abilityB" id="abilityB" placeholder="輸入特性 ; 例如:茂盛" maxlength="5">
                </div>
                <div class="form-group">
                    <span>身高 :</span>
                    <input type="text" class="form-control" name="h" id="h" placeholder="輸入身高 ; 例如:100.5" maxlength="5">
                </div>
                <div class="form-group">
                    <span>體重 :</span>
                    <input type="text" class="form-control" name="w" id="w" placeholder="輸入體重 ; 例如:56.5" maxlength="5">
                </div>
                <div class="form-group">
                    <span>分類 :</span>
                    <input type="text" class="form-control" name="group" id="pokeGroup" placeholder="輸入分類 ; 例如:種子寶可夢" maxlength="10">
                </div>
                <div class="form-group">
                    <span>性別分布 :</span>
                    <input type="text" class="form-control" name="gender" id="gender" placeholder="雄性 ___% / 雌性 ___% 或 無性別" maxlength="20">
                </div>
                <div class="form-group">
                    <span>HP :</span>
                    <input type="text" class="form-control" name="hp" id="hp" placeholder="輸入HP值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>攻擊 :</span>
                    <input type="text" class="form-control" name="att" id="att" placeholder="輸入攻擊值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>防禦 :</span>
                    <input type="text" class="form-control" name="def" id="def" placeholder="輸入防禦值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>特別攻擊 :</span>
                    <input type="text" class="form-control" name="sAtt" id="sAtt" placeholder="輸入特別攻擊值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>特別防禦 :</span>
                    <input type="text" class="form-control" name="sDef" id="sDef" placeholder="輸入特別防禦值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>速度 :</span>
                    <input type="text" class="form-control" name="speed" id="speed" placeholder="輸入速度值" maxlength="3">
                </div>
                <div class="form-group">
                    <span>描述 :</span>
                    <input type="text" class="form-control" name="des" id="des" placeholder="描述" maxlength="100">
                </div>
                <div class="form-group">
                    <span>上傳圖片</span>
                    <input type="file" class="form-control" name="upload" id="fileUpload" accept="image/png, image/jpeg">
                </div>
            </form>
            <div class="form-group">
                <button type="submit" class="btn btn-success btn-lg btn-block" id="btnOK">確認</button>
            </div>
        </div>

    </div>




    <script>
        if (loginTemp) {
            var start = document.cookie.indexOf("cName=") + 6;
            var end = document.cookie.indexOf(";", start);
            if (end == -1)
                end = document.cookie.length;
            $(".logIn").html(`<span>歡迎回來, ${document.cookie.substring(start, end)} [<a href="" onclick="logout()">登出</a>]</span>`);
        }

        var check = 0;
        //判斷是修改還是新增
        var dataList;
        var id = getUrlVars()["id"];
        if (id) {
            $("#titleTxtA").html("修改");
            $("#titleTxtB").html("修改寶可夢資料");
            check = 1;
            $.get("/odata/pokeInfoes", function (e) {
                dataList = e.value;
                var temp = dataList[parseInt(id)];
                $("#num").val(temp.num);
                $("#cName").val(temp.cName);
                $("#typeA").val($.trim(temp.typeA));
                $("#typeB").val($.trim(temp.typeB));
                $("#abilityA").val(temp.abilityA);
                $("#abilityB").val(temp.abilityB);
                $("#h").val(temp.h);
                $("#w").val(temp.w);
                $("#pokeGroup").val(temp.pokeGroup);
                $("#gender").val(temp.gender);
                $("#hp").val(temp.hp);
                $("#att").val(temp.attack);
                $("#def").val(temp.defens);
                $("#sAtt").val(temp.sAttack);
                $("#sDef").val(temp.sDefencs);
                $("#speed").val(temp.speed);
                $("#des").val(temp.describe);
            })
        }
        //判斷是修改還是新增

        //<!--Title Pokemon編號名稱在小螢幕時取消顯示-->
        var a = 2;

        if (parseInt($(window).width()) > 700) {
            $("#title2").before('<div class="title" onclick="jumpIndex()" id="title1">寶可夢圖鑑</div>')
        }

        $(window).resize(function () {
            if (parseInt($(window).width()) < 700) {
                $("#title1").remove();
                a = 1;
            } else if (a == 1) {
                a = 2;
                $("#title2").before('<div class="title" onclick="jumpIndex()" id="title1">寶可夢圖鑑</div>');
            }
        });
        //< !--Title Pokemon編號名稱在小螢幕時取消顯示-- >

        //確認是否重複資料
        $(document).on("click", "#btnOK", function () {
            if (check == 0) {
                var flag = false;
                $("#nameA").css("visibility", "hidden");
                $("#numA").css("visibility", "hidden");
                if (!$("#cName").val()) {
                    $("#nameA").css("visibility", "visible");
                    window.location.hash = "#cName";
                    flag = true;
                }
                if (!$("#num").val()) {
                    $("#numA").css("visibility", "visible");
                    window.location.hash = "#num";
                    flag = true;
                }
                if (flag)
                    return;

                $.get("/odata/pokeInfoes", function (e) {
                    var dataList = e.value;
                    var count = e.value.length;
                    for (var i = 0; i < count; i++) {
                        if (dataList[i].num == parseInt($("#num").val()) || dataList[i].cName == $("#cName").val()) {
                            alert("資料已存在!");
                            flag = true;
                            continue;
                        }
                    }
                    if (!flag)
                        addPokemonInfo();
                })
            } else {
                editPokemonInfo();
            }
        })
        //確認是否重複資料
        //post新資料進資料庫
        function addPokemonInfo() {
            pictureAdd()
            var start = document.cookie.indexOf("uid=") + 4;
            var end = document.cookie.indexOf(";", start);
            var str = document.cookie.substring(start, end);
            //以下，將資料寫進資料庫
            var newItem = {
                num: $("#num").val(),
                cName: $("#cName").val(),
                typeA: $("#typeA").val(),
                typeB: $("#typeB").val(),
                abilityA: $("#abilityA").val(),
                abilityB: $("#abilityB").val(),
                h: $("#h").val(),
                w: $("#w").val(),
                pokeGroup: $("#pokeGroup").val(),
                gender: $("#gender").val(),
                hp: $("#hp").val(),
                attack: $("#att").val(),
                defens: $("#def").val(),
                sAttack: $("#sAtt").val(),
                sDefencs: $("#sDef").val(),
                speed: $("#speed").val(),
                describe: $("#des").val(),
                creator: str
            }
            $.ajax({
                type: "post",
                url: "/odata/pokeInfoes",
                contentType: "application/json",
                data: JSON.stringify(newItem)
            }).then(function () {
                document.location.href = "Paging.html?num=" + parseInt($("#num").val());
                document.cookie = "Number=" + $("#num").val();
                alert("資料已新增!");
            })
        }
        //post新資料進資料庫
        //put資料進資料庫
        function editPokemonInfo() {
            var data;
            console.log(id);
            $.get("/odata/pokeInfoes", function (e) {
                dataList = e.value;
                data = dataList[parseInt(id)];
                data.num = $("#num").val();
                data.cName = $("#cName").val();
                data.typeA = $("#typeA").val();
                data.typeB = $("#typeB").val();
                data.abilityA = $("#abilityA").val();
                data.abilityB = $("#abilityB").val();
                data.h = $("#h").val();
                data.w = $("#w").val();
                data.pokeGroup = $("#pokeGroup").val();
                data.gender = $("#gender").val();
                data.hp = $("#hp").val();
                data.attack = $("#att").val();
                data.defens = $("#def").val();
                data.sAttack = $("#sAtt").val();
                data.sDefencs = $("#sDef").val();
                data.speed = $("#speed").val();
                data.describe = $("#des").val();
                var url = "/odata/pokeInfoes(" + (parseInt(id) + 1) + ")";
                console.log(url);
                pictureAdd();
                $.ajax({
                    type: "put",
                    url: url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).then(function () {
                    document.location.href = "Paging.html?num=" + dataList[id].num;
                    document.cookie = "Number=" + dataList[id].num;
                    alert("資料已修改!");
                })
            });
        }
        //put資料進資料庫
        //將上傳圖片存檔
        function pictureAdd() {
            var data = new FormData();

            var files = $("#fileUpload").get(0).files;
            // Add the uploaded image content to the form data collection
            if (files.length > 0) {
                data.append("UploadedImage", files[0]);
                data.append("num", $("#num").val());
            }

            // Make Ajax request with the contentType = false, and procesDate = false
            $.ajax({
                type: "POST",
                url: "/api/file/UploadFile",
                contentType: false,
                processData: false,
                data: data
            });
        }
        //將上傳圖片存檔
        //擷取QueryString值
        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
                                //擷取QueryString值
    </script>

</body>
</html>                                		                            